name: Quest Quality Gate

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Code Quality and Testing
  quality-gate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ® Checkout Quest Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âš¡ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install Quest Dependencies
      run: npm ci

    - name: ğŸ” Lint Check
      run: npm run lint

    - name: ğŸ¯ Type Check
      run: npm run type-check

    - name: ğŸ§ª Run All Tests
      run: npm run test -- --coverage

    - name: ğŸ“Š Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: quest-scheduler-coverage

    - name: ğŸ—ï¸ Test Production Build
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    - name: ğŸ“ Bundle Size Check
      uses: andresz1/size-limit-action@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

  # Accessibility Testing
  accessibility-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ® Checkout Quest Code
      uses: actions/checkout@v4

    - name: âš¡ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build Application
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    - name: ğŸ¯ Run Accessibility Tests
      run: |
        npx serve -s dist -p 3000 &
        sleep 5
        npx @axe-core/cli http://localhost:3000 --exit

  # Visual Regression Testing (if we had Chromatic set up)
  visual-testing:
    runs-on: ubuntu-latest
    if: false # Disabled for now, enable when Chromatic is set up
    
    steps:
    - name: ğŸ® Checkout Quest Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âš¡ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ“¸ Run Visual Tests
      run: npm run chromatic
      env:
        CHROMATIC_PROJECT_TOKEN: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}

  # Performance Testing
  lighthouse-ci:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ® Checkout Quest Code
      uses: actions/checkout@v4

    - name: âš¡ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build Application
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    - name: ğŸš¦ Run Lighthouse CI
      run: |
        npx serve -s dist -p 3000 &
        sleep 5
        npx @lhci/cli@0.12.x autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # Comment PR with Results
  pr-comment:
    needs: [quality-gate, accessibility-test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ® Create PR Comment
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const qualityStatus = '${{ needs.quality-gate.result }}';
          const a11yStatus = '${{ needs.accessibility-test.result }}';
          
          let emoji = 'âœ…';
          let message = 'All quest quality checks passed! Ready for adventure! ğŸ®';
          
          if (qualityStatus === 'failure' || a11yStatus === 'failure') {
            emoji = 'âŒ';
            message = 'Some quest checks failed. The realm needs your attention! âš”ï¸';
          } else if (qualityStatus === 'cancelled' || a11yStatus === 'cancelled') {
            emoji = 'â¸ï¸';
            message = 'Quest checks were cancelled. Try again, brave adventurer! ğŸ›¡ï¸';
          }
          
          const comment = `## ${emoji} Quest Quality Report
          
          **Quality Gate:** ${qualityStatus === 'success' ? 'âœ… Passed' : qualityStatus === 'failure' ? 'âŒ Failed' : 'â¸ï¸ Cancelled'}
          **Accessibility:** ${a11yStatus === 'success' ? 'âœ… Passed' : a11yStatus === 'failure' ? 'âŒ Failed' : 'â¸ï¸ Cancelled'}
          
          ${message}
          
          *May your code be bug-free and your quests be epic! ğŸš€*`;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: comment
          });